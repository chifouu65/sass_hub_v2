<div class="py-8 bg-slate-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
    <div
      class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
    >
      <div>
        <h1 class="text-3xl font-bold text-slate-900">Organisations</h1>
        <p class="text-sm text-slate-600">
          Créez, modifiez et gérez les membres de vos organisations
          multi-tenant.
        </p>
      </div>
      <div class="flex items-center gap-2">
        <button
          type="button"
          class="btn btn-secondary"
          routerLink="/dashboard"
        >
          Retour au tableau de bord
        </button>
        <button
          type="button"
          (click)="onRefresh()"
          class="btn btn-primary"
        >
          Rafraîchir
        </button>
      </div>
    </div>

    @if (error(); as message) {
    <div
      class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"
    >
      {{ message }}
    </div>
    }

    <div class="md:flex md:gap-6">
      <ul
        class="mb-4 flex flex-col gap-2 text-sm font-medium text-gray-600 md:mb-0 md:me-4"
      >
        @for (tab of tabs; track tab.id) {
        <li>
          <button
            type="button"
            (click)="setActiveTab(tab.id)"
            class="inline-flex w-full items-center gap-2 rounded-lg px-4 py-3 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            [ngClass]="
              isActiveTab(tab.id)
                ? 'bg-blue-700 text-white'
                : 'bg-gray-50 text-gray-600 hover:bg-gray-100 hover:text-gray-900'
            "
            [attr.aria-current]="isActiveTab(tab.id) ? 'page' : null"
          >
            @switch (tab.id) { @case ('organizations') {
            <svg
              class="h-4 w-4"
              [ngClass]="
                isActiveTab(tab.id)
                  ? 'text-white'
                  : 'text-gray-500'
              "
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M10 0a10 10 0 1 0 10 10A10.011 10.011 0 0 0 10 0Zm0 5a3 3 0 1 1 0 6 3 3 0 0 1 0-6Zm0 13a8.949 8.949 0 0 1-4.951-1.488A3.987 3.987 0 0 1 9 13h2a3.987 3.987 0 0 1 3.951 3.512A8.949 8.949 0 0 1 10 18Z"
              />
            </svg>
            } @case ('members') {
            <svg
              class="h-4 w-4"
              [ngClass]="
                isActiveTab(tab.id)
                  ? 'text-white'
                  : 'text-gray-500'
              "
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="currentColor"
              viewBox="0 0 18 18"
            >
              <path
                d="M6.143 0H1.857A1.857 1.857 0 0 0 0 1.857v4.286C0 7.169.831 8 1.857 8h4.286A1.857 1.857 0 0 0 8 6.143V1.857A1.857 1.857 0 0 0 6.143 0Zm10 0h-4.286A1.857 1.857 0 0 0 10 1.857v4.286C10 7.169 10.831 8 11.857 8h4.286A1.857 1.857 0 0 0 18 6.143V1.857A1.857 1.857 0 0 0 16.143 0Zm-10 10H1.857A1.857 1.857 0 0 0 0 11.857v4.286C0 17.169.831 18 1.857 18h4.286A1.857 1.857 0 0 0 8 16.143v-4.286A1.857 1.857 0 0 0 6.143 10Zm10 0h-4.286A1.857 1.857 0 0 0 10 11.857v4.286c0 1.026.831 1.857 1.857 1.857h4.286A1.857 1.857 0 0 0 18 16.143v-4.286A1.857 1.857 0 0 0 16.143 10Z"
              />
            </svg>
            } @case ('roles') {
            <svg
              class="h-4 w-4"
              [ngClass]="
                isActiveTab(tab.id)
                  ? 'text-white'
                  : 'text-gray-500'
              "
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="currentColor"
              viewBox="0 0 20 20"
            >
              <path
                d="M18 7.5h-.423l-.452-1.09.3-.3a1.5 1.5 0 0 0 0-2.121L16.01 2.575a1.5 1.5 0 0 0-2.121 0l-.3.3-1.089-.452V2A1.5 1.5 0 0 0 11 .5H9A1.5 1.5 0 0 0 7.5 2v.423l-1.09.452-.3-.3a1.5 1.5 0 0 0-2.121 0L2.576 3.99a1.5 1.5 0 0 0 0 2.121l.3.3L2.423 7.5H2A1.5 1.5 0 0 0 .5 9v2A1.5 1.5 0 0 0 2 12.5h.423l.452 1.09-.3.3a1.5 1.5 0 0 0 0 2.121l1.415 1.413a1.5 1.5 0 0 0 2.121 0l.3-.3 1.09.452V18A1.5 1.5 0 0 0 9 19.5h2a1.5 1.5 0 0 0 1.5-1.5v-.423l1.09-.452.3.3a1.5 1.5 0 0 0 2.121 0l1.415-1.414a1.5 1.5 0 0 0 0-2.121l-.3-.3.452-1.09H18a1.5 1.5 0 0 0 1.5-1.5V9A1.5 1.5 0 0 0 18 7.5Zm-8 6a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7Z"
              />
            </svg>
            } }
            <span class="truncate">{{ tab.label }}</span>
          </button>
        </li>
        }
      </ul>

      <div class="flex-1">
        @switch (activeTab()) { @case ('organizations') {
        <div
          class="rounded-lg bg-gray-50 p-6 shadow-sm"
        >
          <div
            class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between"
          >
            <div class="space-y-1">
              <h2 class="text-lg font-semibold text-slate-900">
                Organisations
              </h2>
              <p class="text-xs text-slate-500">
                Gérez vos organisations multi-tenant et leurs métadonnées.
              </p>
            </div>
            <div class="flex items-center gap-2 md:justify-end">
              <button
                type="button"
                class="btn btn-primary btn-sm"
                (click)="openCreateModal()"
              >
                <svg
                  class="mr-2 h-3.5 w-3.5"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                >
                  <path
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                  />
                </svg>
                Créer une organisation
              </button>
              <button
                type="button"
                class="btn btn-secondary btn-sm"
                (click)="onRefresh()"
              >
                Rafraîchir
              </button>
            </div>
          </div>

          <div class="mt-6">
            <app-generic-table
              [headers]="tableHeaders"
              [data]="organizations()"
              [loading]="loading()"
              [skeletonRows]="tableSkeletonRows"
              [rowTemplate]="organizationRow"
              [skeletonTemplate]="organizationSkeleton"
              [emptyTemplate]="organizationEmpty"
              [footerTemplate]="organizationFooter"
              [trackBy]="trackOrganization"
              [showToolbar]="false"
            >
            </app-generic-table>
          </div>
        </div>
        } @case ('members') {
        <div
          class="rounded-lg bg-gray-50 p-6 shadow-sm"
        >
          <app-organization-members></app-organization-members>
        </div>
        } @case ('roles') {
        <div
          class="rounded-lg bg-gray-50 p-6 shadow-sm"
        >
          <app-organization-roles></app-organization-roles>
        </div>
        } }
      </div>
    </div>

  </div>

</div>

<ng-template #organizationRow let-organization>
  <tr
    class="border-b border-gray-100 text-sm transition-colors"
    [ngClass]="{
      'bg-indigo-50/70': selectedOrganizationId() === organization.id
    }"
  >
    <td class="px-4 py-4">
      <button
        type="button"
        class="btn btn-ghost w-full justify-start text-left"
        (click)="onSelectOrganization(organization.id)"
      >
        <div class="flex items-center gap-2">
          <span class="font-semibold text-slate-900">
            {{ organization.name }}
          </span>
          @if (selectedOrganizationId() === organization.id) {
          <span
            class="rounded-full bg-indigo-100 px-2 py-0.5 text-[11px] font-medium text-indigo-700"
          >
            Sélectionnée
          </span>
          }
        </div>
        <p class="mt-1 text-xs text-slate-500">
          Créée le {{ organization.createdAt | date: 'short' }}
        </p>
      </button>
    </td>
    <td class="px-4 py-4 text-xs text-slate-600">{{ organization.slug }}</td>
    <td class="px-4 py-4 text-xs text-slate-600">
      {{ organization.databaseName ?? '—' }}
    </td>
    <td class="px-4 py-4 text-xs text-slate-500">
      {{ organization.updatedAt | date: 'short' }}
    </td>
    <td class="px-4 py-4 text-right space-x-2">
      <button
        type="button"
        class="btn btn-secondary btn-sm"
        (click)="openUpdateModal(organization)"
      >
        Modifier
      </button>
      <button
        type="button"
        class="btn btn-danger btn-sm"
        (click)="openDeleteModal(organization)"
      >
        Supprimer
      </button>
    </td>
  </tr>
</ng-template>

<ng-template #organizationSkeleton>
  <tr class="border-b border-gray-100">
    <td class="px-4 py-4" colspan="5">
      <div class="flex items-center gap-4">
        <app-skeleton height="1rem" width="20%"></app-skeleton>
        <app-skeleton height="1rem" width="15%"></app-skeleton>
        <app-skeleton height="1rem" width="15%"></app-skeleton>
        <app-skeleton height="1rem" width="20%"></app-skeleton>
        <app-skeleton height="2rem" width="6rem"></app-skeleton>
      </div>
    </td>
  </tr>
</ng-template>

<ng-template #organizationEmpty>
  <p class="text-sm text-slate-500">
    Aucune organisation pour le moment. Utilisez le formulaire ci-dessus pour en
    créer une.
  </p>
</ng-template>

<ng-template #organizationFooter>
  <div
    class="flex flex-col gap-2 text-xs text-slate-500 sm:flex-row sm:items-center sm:justify-between"
  >
    <span>
      Total :
      <span class="font-semibold text-slate-900">
        {{ organizations().length }}
      </span>
      organisation{{ organizations().length > 1 ? 's' : '' }}
    </span>
    <span>
      Organisation sélectionnée : @if (selectedOrganizationId(); as currentId) {
      {{ findOrganizationName(currentId) }} } @else { aucune }
    </span>
  </div>
</ng-template>
