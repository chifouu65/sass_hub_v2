<lib-section-shell>
  <h2 section-title class="text-xl font-semibold text-slate-900">
    Applications souscrites
  </h2>
  <p section-subtitle class="text-sm text-slate-600">
    Gérez les applications installées pour l’organisation sélectionnée.
  </p>
  <div section-actions>
    <button
      type="button"
      class="btn btn-primary"
      (click)="openSubscribeModal()"
      [disabled]="!selectedOrganizationId()"
    >
      Souscrire à une application
    </button>
  </div>

  <div section-search>
    <lib-search-table-toolbar
      searchId="applications-search"
      label="Rechercher une application"
      placeholder="Rechercher une application"
      name="applications-search"
      [value]="searchTerm()"
      (valueChange)="onSearch($event)"
    >
      <span search-right>
        {{ filteredApplications().length }} résultat{{ filteredApplications().length > 1 ? 's' : '' }}
        sur {{ applications().length }}
      </span>
    </lib-search-table-toolbar>
  </div>

  <div section-body>
    <div class="rounded-lg border border-slate-200 bg-white shadow-sm">
      <app-generic-table
        [headers]="tableHeaders()"
        [data]="filteredApplications()"
        [loading]="applicationsLoading()"
        [trackBy]="trackApplication.bind(this)"
        [showToolbar]="false"
        [skeletonRows]="4"
        [rowTemplate]="applicationRow"
        [emptyTemplate]="emptyTemplate"
      >
      </app-generic-table>
    </div>
  </div>
</lib-section-shell>

<ng-template #applicationRow let-application>
  <tr class="border-t border-slate-100">
    <td class="px-4 py-4 align-top">
      <div class="space-y-1">
        <div class="text-sm font-semibold text-slate-900">
          {{ application.name }}
        </div>
        <div class="text-xs text-slate-500">
          {{ application.slug }}
        </div>
        @if (application.description) {
          <p class="text-xs text-slate-500">
            {{ application.description }}
          </p>
        }
        @if (application.category) {
          <span
            class="inline-flex items-center rounded-full bg-slate-100 px-2.5 py-0.5 text-[11px] font-medium text-slate-600"
          >
            {{ application.category }}
          </span>
        }
      </div>
    </td>
    <td class="px-4 py-4 align-top">
      <div class="flex flex-col gap-2">
        <span
          class="inline-flex items-center gap-2 rounded-full px-2.5 py-1 text-xs font-medium"
          [class]="statusBadgeClass(application.subscriptionStatus)"
        >
          {{ $any(subscriptionStatusLabels)[application.subscriptionStatus] ?? application.subscriptionStatus }}
        </span>
        <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2.5 py-1 text-xs font-medium text-slate-600">
          {{ application.applicationStatus | titlecase }}
        </span>
      </div>
    </td>
    <td class="px-4 py-4 align-top">
      <div class="space-y-1 text-sm text-slate-600">
        <div>
          <span class="font-semibold text-slate-700">Souscrite le :</span>
          {{ application.subscribedAt | date: 'longDate' }}
        </div>
        @if (application.startsAt) {
          <div>
            <span class="font-semibold text-slate-700">Début :</span>
            {{ application.startsAt | date: 'longDate' }}
          </div>
        }
        @if (application.endsAt) {
          <div>
            <span class="font-semibold text-slate-700">Fin :</span>
            {{ application.endsAt | date: 'longDate' }}
          </div>
        }
      </div>
    </td>
    <td class="px-4 py-4 text-right align-top">
      <div class="flex justify-end gap-2">
        <button
          type="button"
          class="btn btn-secondary btn-sm hidden sm:inline-flex"
          (click)="confirmUnsubscribe(application)"
          [disabled]="!!unsubscribeState()[application.subscriptionId]"
        >
          @if (unsubscribeState()[application.subscriptionId]) {
            <i class="mdi mdi-loading mdi-spin text-sm"></i>
          }
          Désinstaller
        </button>
        <button
          type="button"
          class="btn btn-icon sm:hidden text-red-600 hover:text-red-700 hover:bg-red-50"
          aria-label="Désinstaller"
          (click)="confirmUnsubscribe(application)"
          [disabled]="!!unsubscribeState()[application.subscriptionId]"
        >
          @if (unsubscribeState()[application.subscriptionId]) {
            <i class="mdi mdi-loading mdi-spin text-base"></i>
          } @else {
            <i class="mdi mdi-delete text-base"></i>
          }
        </button>
      </div>
    </td>
  </tr>
</ng-template>

<ng-template #emptyTemplate>
  <tr>
    <td class="px-4 py-6 text-center text-sm text-slate-500" [attr.colspan]="tableHeaders().length">
      {{ emptyStateMessage() }}
    </td>
  </tr>
</ng-template>

