<section class="space-y-6">
  <div
    class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
  >
    <div class="space-y-2">
      <div>
        <h2 class="text-lg font-semibold text-slate-900">Rôles</h2>
        <p class="text-xs text-slate-500">
          Consultez les rôles disponibles et leurs permissions pour chaque
          organisation.
        </p>
      </div>
      <div class="text-xs text-slate-500">
        {{ roles().length }} rôle{{
          roles().length > 1 ? 's' : ''
        }}
        disponible{{ roles().length > 1 ? 's' : '' }}
      </div>
    </div>
    <div class="flex items-center gap-2 md:justify-end">
      <button
        type="button"
        class="btn btn-primary btn-sm"
        (click)="openCreateRoleModal()"
        [disabled]="!selectedOrganizationId() || permissions().length === 0"
      >
        Créer un rôle
      </button>
    </div>
  </div>

  <form
    class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between"
    role="search"
    (submit)="$event.preventDefault()"
  >
    <div class="relative w-full md:max-w-md">
      <label class="sr-only" for="role-search">Rechercher un rôle</label>
      <div
        class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400"
      >
        <svg
          aria-hidden="true"
          class="h-5 w-5"
          fill="currentColor"
          viewBox="0 0 20 20"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            fill-rule="evenodd"
            d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
            clip-rule="evenodd"
          />
        </svg>
      </div>
      <input
        id="role-search"
        type="search"
        class="form-input w-full pl-10 pr-3"
        placeholder="Rechercher par nom, slug ou permission"
        autocomplete="off"
        [value]="roleSearchTerm()"
        (input)="onRoleSearchChange($any($event.target).value)"
      />
    </div>
    <div class="flex items-center gap-3 text-sm text-slate-500 md:justify-end">
      <span>
        {{ filteredRoles().length }} résultat{{
          filteredRoles().length > 1 ? 's' : ''
        }}
        sur {{ roles().length }}
      </span>
    </div>
  </form>

  @if (error(); as message) {
  <div
    class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"
  >
    {{ message }}
  </div>
  } @if (organizations().length === 0 && !loading()) {
  <div
    class="rounded-xl border border-dashed border-slate-200 bg-white py-12 text-center text-sm text-slate-500"
  >
    Créez une organisation pour commencer à définir des rôles personnalisés.
  </div>
  } @else {
  <app-generic-table
    [headers]="tableHeaders"
    [data]="filteredRoles()"
    [loading]="loading()"
    [skeletonRows]="tableSkeletonRows"
    [rowTemplate]="roleRow"
    [skeletonTemplate]="roleSkeleton"
    [emptyTemplate]="rolesEmpty"
    [footerTemplate]="rolesFooter"
    [trackBy]="trackRole"
    [showToolbar]="false"
  >
  </app-generic-table>
  }
</section>

<ng-template #roleRow let-role>
  <tr
    class="border-b border-slate-200 text-sm transition-colors"
    [ngClass]="{
      'bg-indigo-50/50': role.isSystem
    }"
  >
    <td class="px-4 py-4 align-top">
      <div class="font-semibold text-slate-900">
        {{ role.name }}
      </div>
      <div class="text-xs text-slate-500">slug : {{ role.slug }}</div>
      @if (role.description) {
      <p class="mt-2 text-xs text-slate-600">
        {{ role.description }}
      </p>
      }
    </td>
    <td class="px-4 py-4 align-top text-sm">
      <span
        class="inline-flex items-center rounded-full px-3 py-1 text-[11px] font-medium"
        [class.bg-indigo-100]="role.isSystem"
        [class.text-indigo-700]="role.isSystem"
        [class.bg-emerald-100]="!role.isSystem"
        [class.text-emerald-700]="!role.isSystem"
      >
        {{ role.isSystem ? 'Rôle système' : 'Rôle personnalisé' }}
      </span>
    </td>
    <td class="px-4 py-4 align-top text-sm text-slate-700">
      @if (role.permissions.length > 0) {
      <div class="flex flex-col gap-2">
        <span class="text-sm font-medium text-slate-900">
          {{ role.permissions.length }} permission{{
            role.permissions.length > 1 ? 's' : ''
          }}
        </span>
        <button
          type="button"
          class="btn btn-secondary btn-xs self-start"
          (click)="openRolePermissionsModal(role)"
        >
          Voir les détails
        </button>
      </div>
      } @else {
      <span class="text-xs text-slate-400">Aucune permission associée</span>
      }
    </td>
    <td class="px-4 py-4 align-top text-sm text-slate-500">
      {{ role.updatedAt | date : 'short' }}
    </td>
    <td class="px-4 py-4 align-top text-sm text-right">
      @if (role.isSystem) {
      <span class="text-xs font-medium text-indigo-600">
        Action non disponible
      </span>
      } @else {
      <div class="flex justify-end gap-2">
        <button
          type="button"
          class="btn btn-secondary btn-sm"
          (click)="openUpdateRoleModal(role)"
        >
          Modifier
        </button>
        <button
          type="button"
          class="btn btn-danger btn-sm"
          [disabled]="deleteRoleInProgress() === role.id"
          (click)="deleteRole(role)"
        >
          @if (deleteRoleInProgress() === role.id) {
          <svg class="mr-2 h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
            ></path>
          </svg>
          } Supprimer
        </button>
      </div>
      }
    </td>
  </tr>
</ng-template>

<ng-template #roleSkeleton>
  <tr class="border-b border-slate-200">
    <td class="px-4 py-4">
      <div class="space-y-2">
        <app-skeleton height="1rem" width="45%"></app-skeleton>
        <app-skeleton height="0.75rem" width="35%"></app-skeleton>
      </div>
    </td>
    <td class="px-4 py-4">
      <app-skeleton height="0.85rem" width="60%"></app-skeleton>
    </td>
    <td class="px-4 py-4">
      <div class="space-y-2">
        <app-skeleton height="1rem" width="80%"></app-skeleton>
        <app-skeleton height="0.75rem" width="65%"></app-skeleton>
      </div>
    </td>
    <td class="px-4 py-4">
      <app-skeleton height="0.85rem" width="40%"></app-skeleton>
    </td>
    <td class="px-4 py-4 text-right">
      <app-skeleton height="2rem" width="6rem"></app-skeleton>
    </td>
  </tr>
</ng-template>

<ng-template #rolesEmpty>
  <div class="py-6 text-center text-sm text-slate-500">
    @if (roleSearchTerm()) { Aucun rôle ne correspond à « {{
      roleSearchTerm()
    }} ». } @else { Aucun rôle n’est défini pour cette organisation. }
  </div>
</ng-template>

<ng-template #rolesFooter>
  <div
    class="flex flex-col gap-2 text-xs text-slate-500 sm:flex-row sm:items-center sm:justify-between"
  >
    <span>
      Total :
      <span class="font-semibold text-slate-900">
        {{ filteredRoles().length }}
      </span>
      rôle{{ filteredRoles().length > 1 ? 's' : '' }} affiché{{
        filteredRoles().length > 1 ? 's' : ''
      }}
      (sur {{ roles().length }})
    </span>
    <span> Permissions disponibles : {{ availablePermissions().length }} </span>
  </div>
</ng-template>
