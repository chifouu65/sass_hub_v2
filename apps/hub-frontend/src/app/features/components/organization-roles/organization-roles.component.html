<lib-section-shell>
  <h2 section-title class="text-lg font-semibold text-slate-900">Rôles</h2>
  <p section-subtitle class="text-xs text-slate-500">
    Consultez les rôles disponibles et leurs permissions pour chaque organisation.
  </p>
  <div section-actions>
    <button
      type="button"
      class="btn btn-primary btn-sm"
      (click)="openCreateRoleModal()"
      [disabled]="!selectedOrganizationId() || permissions().length === 0"
    >
      Créer un rôle
    </button>
  </div>

  <div section-search>
    <lib-search-table-toolbar
      searchId="role-search"
      label="Rechercher un rôle"
      placeholder="Rechercher par nom, slug ou permission"
      [value]="roleSearchTerm()"
      (valueChange)="onRoleSearchChange($event)"
    >
      <span search-right>
        {{ filteredRoles().length }} résultat{{
          filteredRoles().length > 1 ? 's' : ''
        }}
        sur {{ roles().length }}
      </span>
    </lib-search-table-toolbar>
  </div>

  <div section-body>
    @if (error(); as message) {
    <div
      class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"
    >
      {{ message }}
    </div>
    } @if (organizations().length === 0 && !loading()) {
    <div
      class="rounded-xl border border-dashed border-slate-200 bg-white py-12 text-center text-sm text-slate-500"
    >
      Créez une organisation pour commencer à définir des rôles personnalisés.
    </div>
    } @else {
    <app-generic-table
      [headers]="tableHeaders"
      [data]="filteredRoles()"
      [loading]="loading()"
      [skeletonRows]="tableSkeletonRows"
      [rowTemplate]="roleRow"
      [skeletonTemplate]="roleSkeleton"
      [emptyTemplate]="rolesEmpty"
      [footerTemplate]="rolesFooter"
      [trackBy]="trackRole"
      [showToolbar]="false"
    >
    </app-generic-table>
    }
  </div>
</lib-section-shell>

<ng-template #roleRow let-role>
  <tr
    class="border-b border-slate-200 text-sm transition-colors"
    [ngClass]="{
      'bg-indigo-50/50': role.isSystem
    }"
  >
    <td class="px-4 py-4 align-top">
      <div class="font-semibold text-slate-900">
        {{ role.name }}
      </div>
      <div class="text-xs text-slate-500">slug : {{ role.slug }}</div>
      @if (role.description) {
      <p class="mt-2 text-xs text-slate-600">
        {{ role.description }}
      </p>
      }
    </td>
    <td class="px-4 py-4 align-top text-sm">
      <span
        class="inline-flex items-center rounded-full px-3 py-1 text-[11px] font-medium"
        [class.bg-indigo-100]="role.isSystem"
        [class.text-indigo-700]="role.isSystem"
        [class.bg-emerald-100]="!role.isSystem"
        [class.text-emerald-700]="!role.isSystem"
      >
        {{ role.isSystem ? 'Rôle système' : 'Rôle personnalisé' }}
      </span>
    </td>
    <td class="px-4 py-4 align-top text-sm text-slate-700">
      @if (role.permissions.length > 0) {
      <div class="flex flex-col gap-2">
        <span class="text-sm font-medium text-slate-900">
          {{ role.permissions.length }} permission{{
            role.permissions.length > 1 ? 's' : ''
          }}
        </span>
        <button
          type="button"
          class="btn btn-secondary btn-xs self-start hidden sm:inline-flex"
          (click)="openRolePermissionsModal(role)"
        >
          Voir les détails
        </button>
        <button
          type="button"
          class="btn btn-icon sm:hidden"
          aria-label="Voir les détails"
          (click)="openRolePermissionsModal(role)"
        >
          <i class="mdi mdi-information-outline text-base"></i>
        </button>
      </div>
      } @else {
      <span class="text-xs text-slate-400">Aucune permission associée</span>
      }
    </td>
    <td class="px-4 py-4 align-top text-sm text-slate-500">
      {{ role.updatedAt | date : 'short' }}
    </td>
    <td class="px-4 py-4 align-top text-sm text-right">
      @if (role.isSystem) {
      <span class="text-xs font-medium text-indigo-600">
        Action non disponible
      </span>
      } @else {
      <div class="flex justify-end gap-2">
        <button
          type="button"
          class="btn btn-secondary btn-sm hidden sm:inline-flex"
          (click)="openUpdateRoleModal(role)"
        >
          Modifier
        </button>
        <button
          type="button"
          class="btn btn-danger btn-sm hidden sm:inline-flex"
          [disabled]="deleteRoleInProgress() === role.id"
          (click)="deleteRole(role)"
        >
          @if (deleteRoleInProgress() === role.id) {
          <i class="mdi mdi-loading mdi-spin text-sm"></i>
          } Supprimer
        </button>
        <button
          type="button"
          class="btn btn-icon sm:hidden"
          aria-label="Modifier"
          (click)="openUpdateRoleModal(role)"
        >
          <i class="mdi mdi-pencil text-base"></i>
        </button>
        <button
          type="button"
          class="btn btn-icon sm:hidden text-red-600 hover:text-red-700 hover:bg-red-50"
          aria-label="Supprimer"
          [disabled]="deleteRoleInProgress() === role.id"
          (click)="deleteRole(role)"
        >
          @if (deleteRoleInProgress() === role.id) {
            <i class="mdi mdi-loading mdi-spin text-base"></i>
          } @else {
            <i class="mdi mdi-delete text-base"></i>
          }
        </button>
      </div>
      }
    </td>
  </tr>
</ng-template>

<ng-template #roleSkeleton>
  <tr class="border-b border-slate-200">
    <td class="px-4 py-4">
      <div class="space-y-2">
        <app-skeleton height="1rem" width="45%"></app-skeleton>
        <app-skeleton height="0.75rem" width="35%"></app-skeleton>
      </div>
    </td>
    <td class="px-4 py-4">
      <app-skeleton height="0.85rem" width="60%"></app-skeleton>
    </td>
    <td class="px-4 py-4">
      <div class="space-y-2">
        <app-skeleton height="1rem" width="80%"></app-skeleton>
        <app-skeleton height="0.75rem" width="65%"></app-skeleton>
      </div>
    </td>
    <td class="px-4 py-4">
      <app-skeleton height="0.85rem" width="40%"></app-skeleton>
    </td>
    <td class="px-4 py-4 text-right">
      <app-skeleton height="2rem" width="6rem"></app-skeleton>
    </td>
  </tr>
</ng-template>

<ng-template #rolesEmpty>
  <div class="py-6 text-center text-sm text-slate-500">
    @if (roleSearchTerm()) { Aucun rôle ne correspond à « {{
      roleSearchTerm()
    }} ». } @else { Aucun rôle n’est défini pour cette organisation. }
  </div>
</ng-template>

<ng-template #rolesFooter>
  <div
    class="flex flex-col gap-2 text-xs text-slate-500 sm:flex-row sm:items-center sm:justify-between"
  >
    <span>
      Total :
      <span class="font-semibold text-slate-900">
        {{ filteredRoles().length }}
      </span>
      rôle{{ filteredRoles().length > 1 ? 's' : '' }} affiché{{
        filteredRoles().length > 1 ? 's' : ''
      }}
      (sur {{ roles().length }})
    </span>
    <span> Permissions disponibles : {{ availablePermissions().length }} </span>
  </div>
</ng-template>
