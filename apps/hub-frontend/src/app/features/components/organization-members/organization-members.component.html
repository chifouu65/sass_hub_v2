<div class="space-y-6">
  <div
    class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between"
  >
    <div class="space-y-2">
      <div>
        <h2 class="text-lg font-semibold text-gray-900">Membres</h2>
        <p class="text-xs text-gray-500">
          Gérez les utilisateurs associés à l’organisation sélectionnée.
        </p>
      </div>
      <div class="text-xs text-gray-500">
        {{ members().length }} membre{{ members().length > 1 ? 's' : '' }}
        disponible{{ members().length > 1 ? 's' : '' }}
      </div>
    </div>
    <div class="flex items-center gap-2 md:justify-end">
      <button
        type="button"
        class="btn btn-primary btn-sm"
        (click)="openAddMemberModal()"
        [disabled]="addMemberSubmitting() || !selectedOrganizationId()"
      >
        @if (addMemberSubmitting()) {
          <svg
            class="mr-2 h-3.5 w-3.5 animate-spin"
            viewBox="0 0 24 24"
            fill="none"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
            ></path>
          </svg>
        } @else {
          <svg
            class="mr-2 h-3.5 w-3.5"
            fill="currentColor"
            viewBox="0 0 20 20"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <path
              clip-rule="evenodd"
              fill-rule="evenodd"
              d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
            />
          </svg>
        }
        Créer un membre
      </button>
    </div>
  </div>

  <form
    class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between"
    role="search"
    (submit)="$event.preventDefault()"
  >
    <div class="relative w-full md:max-w-md">
      <label class="sr-only" for="member-search">Rechercher un membre</label>
      <div
        class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400"
      >
        <svg
          aria-hidden="true"
          class="h-5 w-5"
          fill="currentColor"
          viewBox="0 0 20 20"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            fill-rule="evenodd"
            d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
            clip-rule="evenodd"
          />
        </svg>
      </div>
      <input
        id="member-search"
        type="search"
        name="member-search"
        class="form-input w-full pl-10 pr-3"
        placeholder="Rechercher un membre"
        autocomplete="off"
        [ngModel]="searchTerm()"
        (ngModelChange)="onSearchTermChange($event)"
      />
    </div>
    <div class="text-sm text-gray-500 md:text-right">
      {{ filteredMembers().length }} résultat{{ filteredMembers().length > 1 ? 's'
      : '' }} sur {{ members().length }}
    </div>
  </form>

  @if (!selectedOrganizationId()) {
    <div
      class="rounded-xl border border-dashed border-gray-300 bg-white p-6 text-sm text-gray-500 shadow-sm"
    >
      Sélectionnez une organisation pour consulter et gérer ses membres.
    </div>
  } @else {
    <app-generic-table
      [headers]="tableHeaders()"
      [data]="filteredMembers()"
      [loading]="membersLoading()"
      [skeletonRows]="tableSkeletonRows()"
      [rowTemplate]="memberRow"
      [skeletonTemplate]="memberSkeleton"
      [emptyTemplate]="emptyState"
      [footerTemplate]="paginationFooter"
      [trackBy]="trackMember"
    >
    </app-generic-table>
  }
</div>

<ng-template #memberRow let-member>
  @let actualRole = member.organizationRoleName ?? member.role ?? null;
  <tr class="border-b border-gray-100">
    <th
      scope="row"
      class="px-4 py-4 font-medium text-gray-900"
    >
      <div class="text-sm font-semibold">
        {{ member.firstName }} {{ member.lastName }}
      </div>
      <div class="text-xs text-gray-500">
        {{ member.email }}
      </div>
      <div class="mt-1 text-[11px] text-gray-400">
        ID&nbsp;: {{ member.userId }}
      </div>
    </th>
    <td class="px-4 py-4 text-sm">
      <div class="font-semibold text-gray-900">
        {{ actualRole ?? 'Non défini' }}
      </div>
      <p class="mt-1 text-xs text-gray-500">
        Identifiant de rôle :
        {{ member.organizationRoleSlug ?? '—' }}
      </p>
    </td>
    <td class="px-4 py-4 text-sm text-gray-500">
      {{ member.createdAt | date: 'short' }}
    </td>
    <td class="px-4 py-4 text-right">
      <div class="flex justify-end gap-2">
        <button
          type="button"
          class="btn btn-secondary btn-sm"
          [disabled]="isMemberUpdating(member)"
          (click)="openUpdateRoleModal(member)"
        >
          @if (isMemberUpdating(member)) {
            <svg
              class="mr-1.5 h-3.5 w-3.5 animate-spin"
              viewBox="0 0 24 24"
              fill="none"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              ></path>
            </svg>
          }
          Modifier
        </button>
        <button
          type="button"
          class="btn btn-danger btn-sm"
          [disabled]="isMemberUpdating(member)"
          (click)="removeMember(member)"
        >
          Supprimer
        </button>
      </div>
    </td>
  </tr>
</ng-template>

<ng-template #memberSkeleton>
  <tr class="border-b border-gray-100">
    <td class="px-4 py-4">
      <div class="space-y-2">
        <app-skeleton height="0.9rem" width="70%"></app-skeleton>
        <app-skeleton height="0.75rem" width="55%"></app-skeleton>
        <app-skeleton height="0.6rem" width="40%"></app-skeleton>
      </div>
    </td>
    <td class="px-4 py-4">
      <app-skeleton height="2.5rem"></app-skeleton>
      <div class="mt-2">
        <app-skeleton height="0.6rem" width="60%"></app-skeleton>
      </div>
    </td>
    <td class="px-4 py-4">
      <app-skeleton height="0.85rem" width="50%"></app-skeleton>
    </td>
    <td class="px-4 py-4 text-right">
      <div class="flex justify-end">
        <app-skeleton height="2rem" width="5rem"></app-skeleton>
      </div>
    </td>
  </tr>
</ng-template>

<ng-template #emptyState>
  <div class="flex flex-col items-center justify-center gap-2 py-6 text-sm">
    <svg
      class="h-8 w-8 text-gray-300"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="1.5"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
      />
    </svg>
    <p class="text-gray-500">
      @if (searchTerm()) {
        Aucun membre ne correspond à «&nbsp;{{ searchTerm() }}&nbsp;».
      } @else {
        Aucun membre pour cette organisation.
      }
    </p>
  </div>
</ng-template>

<ng-template #paginationFooter>
  <div
    class="flex flex-col gap-3 text-sm text-gray-500 md:flex-row md:items-center md:justify-between"
  >
    <span>
      Affichage de
      <span class="font-semibold text-gray-900"
        >{{ paginationInfo().start }}-{{ paginationInfo().end }}</span
      >
      sur
      <span class="font-semibold text-gray-900"
        >{{ paginationInfo().overall }}</span
      >
      membres
    </span>
    <div class="inline-flex items-center gap-2 text-xs">
      <span class="rounded-full bg-gray-100 px-2 py-1">
        {{ filteredMembers().length }} affiché{{ filteredMembers().length > 1 ? 's' : '' }}
      </span>
      <span>
        Recherche :
        @if (searchTerm()) {
          «&nbsp;{{ searchTerm() }}&nbsp;»
        } @else {
          aucune
        }
      </span>
    </div>
  </div>
</ng-template>
