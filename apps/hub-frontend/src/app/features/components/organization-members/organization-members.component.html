<lib-section-shell>
  <h2 section-title class="text-lg font-semibold text-gray-900">Membres</h2>
  <div section-subtitle class="space-y-1 text-xs text-gray-500">
    <p>Gérez les utilisateurs associés à l’organisation sélectionnée.</p>
    <p>
      {{ members().length }} membre{{ members().length > 1 ? 's' : '' }}
      disponible{{ members().length > 1 ? 's' : '' }}
    </p>
  </div>
  <div section-actions>
    <button
      type="button"
      class="btn btn-primary btn-sm"
      (click)="openAddMemberModal()"
      [disabled]="addMemberSubmitting() || !selectedOrganizationId()"
    >
      @if (addMemberSubmitting()) {
        <i class="mdi mdi-loading mdi-spin text-sm"></i>
      } @else {
        <i class="mdi mdi-account-plus text-sm"></i>
      }
      Créer un membre
    </button>
  </div>

  <div section-search>
    <lib-search-table-toolbar
      searchId="member-search"
      label="Rechercher un membre"
      placeholder="Rechercher un membre"
      name="member-search"
      [value]="searchTerm()"
      (valueChange)="onSearchTermChange($event)"
    >
      <span search-right>
        {{ filteredMembers().length }} résultat{{ filteredMembers().length > 1 ? 's'
        : '' }} sur {{ members().length }}
      </span>
    </lib-search-table-toolbar>
  </div>

  <div section-body>
    @if (!selectedOrganizationId()) {
      <div
        class="rounded-xl border border-dashed border-gray-300 bg-white p-6 text-sm text-gray-500 shadow-sm"
      >
        Sélectionnez une organisation pour consulter et gérer ses membres.
      </div>
    } @else {
      <app-generic-table
        [headers]="tableHeaders()"
        [data]="filteredMembers()"
        [loading]="membersLoading()"
        [skeletonRows]="tableSkeletonRows()"
        [rowTemplate]="memberRow"
        [skeletonTemplate]="memberSkeleton"
        [emptyTemplate]="emptyState"
        [footerTemplate]="paginationFooter"
        [trackBy]="trackMember"
      >
      </app-generic-table>
    }
  </div>
</lib-section-shell>

<ng-template #memberRow let-member>
  @let actualRole = member.organizationRoleName ?? member.role ?? null;
  <tr class="border-b border-gray-100">
    <th
      scope="row"
      class="px-4 py-4 font-medium text-gray-900"
    >
      <div class="text-sm font-semibold">
        {{ member.firstName }} {{ member.lastName }}
      </div>
      <div class="text-xs text-gray-500">
        {{ member.email }}
      </div>
      <div class="mt-1 text-[11px] text-gray-400">
        ID&nbsp;: {{ member.userId }}
      </div>
    </th>
    <td class="px-4 py-4 text-sm">
      <div class="font-semibold text-gray-900">
        {{ actualRole ?? 'Non défini' }}
      </div>
      <p class="mt-1 text-xs text-gray-500">
        Identifiant de rôle :
        {{ member.organizationRoleSlug ?? '—' }}
      </p>
    </td>
    <td class="px-4 py-4 text-sm text-gray-500">
      {{ member.createdAt | date: 'short' }}
    </td>
    <td class="px-4 py-4 text-right">
      <div class="flex justify-end gap-2">
        <button
          type="button"
          class="btn btn-secondary btn-sm hidden sm:inline-flex"
          [disabled]="isMemberUpdating(member)"
          (click)="openUpdateRoleModal(member)"
        >
          @if (isMemberUpdating(member)) {
            <i class="mdi mdi-loading mdi-spin text-sm"></i>
          }
          Modifier
        </button>
        <button
          type="button"
          class="btn btn-danger btn-sm hidden sm:inline-flex"
          [disabled]="isMemberUpdating(member)"
          (click)="removeMember(member)"
        >
          Supprimer
        </button>
        <button
          type="button"
          class="btn btn-icon sm:hidden"
          [disabled]="isMemberUpdating(member)"
          aria-label="Modifier"
          (click)="openUpdateRoleModal(member)"
        >
          @if (isMemberUpdating(member)) {
            <i class="mdi mdi-loading mdi-spin text-base"></i>
          } @else {
            <i class="mdi mdi-pencil text-base"></i>
          }
        </button>
        <button
          type="button"
          class="btn btn-icon sm:hidden text-red-600 hover:text-red-700 hover:bg-red-50"
          [disabled]="isMemberUpdating(member)"
          aria-label="Supprimer"
          (click)="removeMember(member)"
        >
          <i class="mdi mdi-delete text-base"></i>
        </button>
      </div>
    </td>
  </tr>
</ng-template>

<ng-template #memberSkeleton>
  <tr class="border-b border-gray-100">
    <td class="px-4 py-4">
      <div class="space-y-2">
        <app-skeleton height="0.9rem" width="70%"></app-skeleton>
        <app-skeleton height="0.75rem" width="55%"></app-skeleton>
        <app-skeleton height="0.6rem" width="40%"></app-skeleton>
      </div>
    </td>
    <td class="px-4 py-4">
      <app-skeleton height="2.5rem"></app-skeleton>
      <div class="mt-2">
        <app-skeleton height="0.6rem" width="60%"></app-skeleton>
      </div>
    </td>
    <td class="px-4 py-4">
      <app-skeleton height="0.85rem" width="50%"></app-skeleton>
    </td>
    <td class="px-4 py-4 text-right">
      <div class="flex justify-end">
        <app-skeleton height="2rem" width="5rem"></app-skeleton>
      </div>
    </td>
  </tr>
</ng-template>

<ng-template #emptyState>
  <div class="flex flex-col items-center justify-center gap-2 py-6 text-sm">
    <i class="mdi mdi-account-search text-3xl text-gray-300"></i>
    <p class="text-gray-500">
      @if (searchTerm()) {
        Aucun membre ne correspond à «&nbsp;{{ searchTerm() }}&nbsp;».
      } @else {
        Aucun membre pour cette organisation.
      }
    </p>
  </div>
</ng-template>

<ng-template #paginationFooter>
  <div
    class="flex flex-col gap-3 text-sm text-gray-500 md:flex-row md:items-center md:justify-between"
  >
    <span>
      Affichage de
      <span class="font-semibold text-gray-900"
        >{{ paginationInfo().start }}-{{ paginationInfo().end }}</span
      >
      sur
      <span class="font-semibold text-gray-900"
        >{{ paginationInfo().overall }}</span
      >
      membres
    </span>
    <div class="inline-flex items-center gap-2 text-xs">
      <span class="rounded-full bg-gray-100 px-2 py-1">
        {{ filteredMembers().length }} affiché{{ filteredMembers().length > 1 ? 's' : '' }}
      </span>
      <span>
        Recherche :
        @if (searchTerm()) {
          «&nbsp;{{ searchTerm() }}&nbsp;»
        } @else {
          aucune
        }
      </span>
    </div>
  </div>
</ng-template>
