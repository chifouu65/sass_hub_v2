<app-section-shell>
  <h2 section-title class="text-lg font-semibold text-slate-900">
    Organisations
  </h2>
  <p section-subtitle class="text-xs text-slate-500">
    Gérez vos organisations multi-tenant et leurs métadonnées.
  </p>
  <div section-actions>
    <button
      type="button"
      class="btn btn-primary btn-sm"
      (click)="openCreateModal()"
    >
      <i class="mdi mdi-plus text-sm"></i>
      Créer une organisation
    </button>
  </div>

  <div section-search>
    <app-search-table-toolbar
      searchId="organization-search"
      label="Rechercher une organisation"
      placeholder="Rechercher par nom, slug ou base de données"
      [value]="searchTerm()"
      (valueChange)="onSearchChange($event)"
    >
      <span search-right>
        {{ filteredOrganizations().length }}
        résultat{{ filteredOrganizations().length > 1 ? 's' : '' }} sur
        {{ organizations().length }}
      </span>
    </app-search-table-toolbar>
  </div>

  <div section-body>
    <app-generic-table
      [headers]="tableHeaders"
      [data]="filteredOrganizations()"
      [loading]="loading()"
      [skeletonRows]="tableSkeletonRows"
      [rowTemplate]="organizationRow"
      [skeletonTemplate]="organizationSkeleton"
      [emptyTemplate]="organizationEmpty"
      [footerTemplate]="organizationFooter"
      [trackBy]="trackOrganization"
      [showToolbar]="false"
    >
    </app-generic-table>
  </div>
</app-section-shell>

<ng-template #organizationRow let-organization>
  <tr
    class="border-b border-gray-100 text-sm transition-colors"
    [ngClass]="{
      'bg-indigo-50/70': selectedOrganizationId() === organization.id
    }"
  >
    <td class="px-4 py-4">
      <button
        type="button"
        class="btn btn-ghost w-full justify-start text-left"
        (click)="onSelectOrganization(organization.id)"
      >
        <div class="flex items-center gap-2">
          <span class="font-semibold text-slate-900">
            {{ organization.name }}
          </span>
          @if (selectedOrganizationId() === organization.id) {
          <span
            class="rounded-full bg-indigo-100 px-2 py-0.5 text-[11px] font-medium text-indigo-700"
          >
            Sélectionnée
          </span>
          }
        </div>
        <p class="mt-1 text-xs text-slate-500">
          Créée le {{ organization.createdAt | date : 'short' }}
        </p>
      </button>
    </td>
    <td class="px-4 py-4 text-xs text-slate-600">{{ organization.slug }}</td>
    <td class="px-4 py-4 text-xs text-slate-600">
      {{ organization.databaseName ?? '—' }}
    </td>
    <td class="px-4 py-4 text-xs text-slate-500">
      {{ organization.updatedAt | date : 'short' }}
    </td>
    <td class="px-4 py-4 text-right space-x-2">
      <button
        type="button"
        class="btn btn-secondary btn-sm hidden sm:inline-flex"
        (click)="openUpdateModal(organization)"
      >
        Modifier
      </button>
      <button
        type="button"
        class="btn btn-danger btn-sm hidden sm:inline-flex"
        (click)="openDeleteModal(organization)"
      >
        Supprimer
      </button>
      <button
        type="button"
        class="btn btn-icon sm:hidden"
        aria-label="Modifier"
        (click)="openUpdateModal(organization)"
      >
        <i class="mdi mdi-pencil text-base"></i>
      </button>
      <button
        type="button"
        class="btn btn-icon sm:hidden text-red-600 hover:text-red-700 hover:bg-red-50"
        aria-label="Supprimer"
        (click)="openDeleteModal(organization)"
      >
        <i class="mdi mdi-delete text-base"></i>
      </button>
    </td>
  </tr>
</ng-template>

<ng-template #organizationSkeleton>
  <tr class="border-b border-gray-100">
    <td class="px-4 py-4" colspan="5">
      <div class="flex items-center gap-4">
        <app-skeleton height="1rem" width="20%"></app-skeleton>
        <app-skeleton height="1rem" width="15%"></app-skeleton>
        <app-skeleton height="1rem" width="15%"></app-skeleton>
        <app-skeleton height="1rem" width="20%"></app-skeleton>
        <app-skeleton height="2rem" width="6rem"></app-skeleton>
      </div>
    </td>
  </tr>
</ng-template>

<ng-template #organizationEmpty>
  <p class="text-sm text-slate-500">
    Aucune organisation pour le moment. Utilisez le formulaire ci-dessus pour en
    créer une.
  </p>
</ng-template>

<ng-template #organizationFooter>
  <div
    class="flex flex-col gap-2 text-xs text-slate-500 sm:flex-row sm:items-center sm:justify-between"
  >
    <span>
      Total :
      <span class="font-semibold text-slate-900">
        {{ filteredOrganizations().length }}
      </span>
      organisation{{ filteredOrganizations().length > 1 ? 's' : '' }}
      affichée{{ filteredOrganizations().length > 1 ? 's' : '' }}
      (sur {{ organizations().length }})
    </span>
    <span>
      Organisation sélectionnée :
      @if (selectedOrganizationId(); as currentId) {
        {{ findOrganizationName(currentId) }}
      } @else {
        aucune
      }
    </span>
  </div>
</ng-template>

