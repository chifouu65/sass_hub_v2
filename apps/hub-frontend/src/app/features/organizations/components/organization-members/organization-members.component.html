<div class="space-y-4">
  <div
    class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
  >
    <div class="space-y-1">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
        Membres
      </h2>
      <p class="text-xs text-gray-500 dark:text-gray-400">
        Gérer les utilisateurs associés à l’organisation sélectionnée.
      </p>
    </div>
    <span
      class="inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-xs font-semibold text-gray-600 dark:bg-gray-800 dark:text-gray-300"
    >
      {{ members().length }} membre{{ members().length > 1 ? 's' : '' }}
    </span>
  </div>

  @if (message(); as feedback) {
    <div
      class="rounded-lg border px-3 py-2 text-xs shadow-sm"
      [class.bg-emerald-50]="feedback.kind === 'success'"
      [class.text-emerald-700]="feedback.kind === 'success'"
      [class.border-emerald-200]="feedback.kind === 'success'"
      [class.bg-red-50]="feedback.kind === 'error'"
      [class.text-red-700]="feedback.kind === 'error'"
      [class.border-red-200]="feedback.kind === 'error'"
    >
      {{ feedback.text }}
    </div>
  }

  @if (!selectedOrganizationId()) {
    <div
      class="rounded-xl border border-dashed border-gray-300 bg-white p-6 text-sm text-gray-500 shadow-sm dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300"
    >
      Sélectionnez une organisation pour consulter et gérer ses membres.
    </div>
  } @else {
    <app-generic-table
      [headers]="tableHeaders()"
      [data]="filteredMembers()"
      [loading]="membersLoading()"
      [skeletonRows]="tableSkeletonRows()"
      [rowTemplate]="memberRow"
      [skeletonTemplate]="memberSkeleton"
      [emptyTemplate]="emptyState"
      [footerTemplate]="paginationFooter"
      [trackBy]="trackMember"
    >
      <form
        table-search
        class="flex items-center"
        role="search"
        (submit)="$event.preventDefault()"
      >
        <label for="member-search" class="sr-only">Rechercher</label>
        <div class="relative w-full">
          <div
            class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400 dark:text-gray-500"
          >
            <svg
              aria-hidden="true"
              class="h-5 w-5"
              fill="currentColor"
              viewBox="0 0 20 20"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill-rule="evenodd"
                d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                clip-rule="evenodd"
              />
            </svg>
          </div>
          <input
            id="member-search"
            type="search"
            class="block w-full rounded-lg border border-gray-300 bg-gray-50 py-2 pl-10 pr-3 text-sm text-gray-900 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-400 dark:focus:border-primary-500"
            placeholder="Rechercher un membre"
            autocomplete="off"
            [ngModel]="searchTerm()"
            (ngModelChange)="onSearchTermChange($event)"
          />
        </div>
      </form>

      <div
        table-actions
        class="flex w-full flex-col items-stretch gap-2 md:w-auto md:flex-row md:items-center md:justify-end md:gap-3"
      >
        <span
          class="order-3 text-xs text-gray-500 dark:text-gray-400 md:order-1"
        >
          {{ filteredMembers().length }} résultat{{ filteredMembers().length > 1 ? 's' : '' }}
        </span>
        @if (searchTerm()) {
          <button
            type="button"
            class="order-2 inline-flex items-center justify-center rounded-lg border border-gray-200 px-3 py-2 text-xs font-semibold text-gray-600 transition hover:bg-gray-100 hover:text-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-200 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700"
            (click)="resetSearch()"
          >
            Effacer
          </button>
        }
        <button
          type="button"
          class="order-1 inline-flex items-center justify-center rounded-lg bg-primary-600 px-4 py-2 text-xs font-semibold text-white shadow-sm transition hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-300 dark:bg-primary-500 dark:hover:bg-primary-600"
          (click)="toggleAddMemberForm()"
        >
          <svg
            class="mr-2 h-3.5 w-3.5"
            fill="currentColor"
            viewBox="0 0 20 20"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
          >
            <path
              clip-rule="evenodd"
              fill-rule="evenodd"
              d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
            />
          </svg>
          {{ showAddMemberForm() ? 'Fermer' : 'Ajouter un membre' }}
        </button>
      </div>
    </app-generic-table>

    @if (showAddMemberForm()) {
      <form
        class="rounded-xl border border-gray-200 bg-gray-50 p-4 shadow-sm dark:border-gray-700 dark:bg-gray-800"
        [formGroup]="addMemberForm"
        (ngSubmit)="onAddMember()"
      >
        <div class="grid gap-4 md:grid-cols-[minmax(0,1fr)_minmax(0,1fr)_auto] md:items-end">
          <div>
            <label
              class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-200"
              for="member-email"
            >
              Email utilisateur
            </label>
            <input
              id="member-email"
              type="email"
              formControlName="email"
              class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200 dark:border-gray-600 dark:bg-gray-900 dark:text-gray-100 dark:focus:border-primary-500"
              placeholder="utilisateur@example.com"
              autocomplete="off"
            />
            @if (addMemberForm.controls['email']?.invalid && addMemberForm.controls['email']?.touched) {
              <p class="mt-1 text-xs text-red-600">
                Fournissez un email valide.
              </p>
            }
          </div>

          <div>
            <label
              class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-200"
              for="member-assignment"
            >
              Rôle assigné
            </label>
            <select
              id="member-assignment"
              formControlName="assignment"
              class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200 dark:border-gray-600 dark:bg-gray-900 dark:text-gray-100 dark:focus:border-primary-500"
            >
              <option value="" disabled>Choisissez un rôle</option>
              @for (option of roleOptions(); track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
          </div>

          <div class="flex items-center gap-2 md:justify-end">
            <button
              type="button"
              class="inline-flex items-center rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-600 transition hover:bg-gray-100 hover:text-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-200 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700"
              (click)="toggleAddMemberForm()"
            >
              Annuler
            </button>
            <button
              type="submit"
              class="inline-flex items-center rounded-lg bg-emerald-600 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-200 disabled:opacity-70"
              [disabled]="addMemberForm.invalid || addMemberSubmitting()"
            >
              @if (addMemberSubmitting()) {
                <svg
                  class="mr-2 h-4 w-4 animate-spin"
                  viewBox="0 0 24 24"
                  fill="none"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
                  ></path>
                </svg>
              }
              Ajouter
            </button>
          </div>
        </div>
      </form>
    }
  }
</div>

<ng-template #memberRow let-member>
  @let actualRole = member.organizationRoleName ?? member.role ?? null;
  <tr class="border-b border-gray-100 dark:border-gray-700">
    <th
      scope="row"
      class="px-4 py-4 font-medium text-gray-900 dark:text-gray-100"
    >
      <div class="text-sm font-semibold">
        {{ member.firstName }} {{ member.lastName }}
      </div>
      <div class="text-xs text-gray-500 dark:text-gray-400">
        {{ member.email }}
      </div>
      <div class="mt-1 text-[11px] text-gray-400 dark:text-gray-500">
        ID&nbsp;: {{ member.userId }}
      </div>
    </th>
    <td class="px-4 py-4 text-sm">
      <select
        class="w-full rounded-lg border border-gray-300 bg-white px-2 py-2 text-sm text-gray-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-200 dark:border-gray-600 dark:bg-gray-900 dark:text-gray-100 dark:focus:border-primary-500"
        [ngModel]="memberAssignments()[member.userId]"
        (ngModelChange)="onAssignmentChange(member.userId, $event)"
      >
        @for (option of roleOptions(); track option.value) {
          <option [value]="option.value">{{ option.label }}</option>
        }
      </select>
      <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
        Actuel :
        @if (actualRole) {
          {{ actualRole }}
        } @else {
          Non défini
        }
      </p>
    </td>
    <td class="px-4 py-4 text-sm text-gray-500 dark:text-gray-400">
      {{ member.createdAt | date: 'short' }}
    </td>
    <td class="px-4 py-4 text-right">
      <div class="flex justify-end gap-2">
        <button
          type="button"
          class="inline-flex items-center rounded-lg border border-primary-200 px-3 py-1.5 text-xs font-semibold text-primary-600 transition hover:bg-primary-50 focus:outline-none focus:ring-2 focus:ring-primary-200 disabled:opacity-60 dark:border-primary-400 dark:text-primary-300 dark:hover:bg-primary-950/40"
          [disabled]="isMemberUpdating(member)"
          (click)="updateMemberAssignment(member)"
        >
          @if (isMemberUpdating(member)) {
            <svg
              class="mr-1.5 h-3.5 w-3.5 animate-spin"
              viewBox="0 0 24 24"
              fill="none"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
              ></path>
            </svg>
          }
          Mettre à jour
        </button>
        <button
          type="button"
          class="inline-flex items-center rounded-lg border border-red-200 px-3 py-1.5 text-xs font-semibold text-red-600 transition hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-200 disabled:opacity-60 dark:border-red-500/70 dark:text-red-300 dark:hover:bg-red-900/30"
          [disabled]="isMemberUpdating(member)"
          (click)="removeMember(member)"
        >
          Supprimer
        </button>
      </div>
    </td>
  </tr>
</ng-template>

<ng-template #memberSkeleton>
  <tr class="border-b border-gray-100 dark:border-gray-700">
    <td class="px-4 py-4">
      <div class="space-y-2">
        <app-skeleton height="0.9rem" width="70%"></app-skeleton>
        <app-skeleton height="0.75rem" width="55%"></app-skeleton>
        <app-skeleton height="0.6rem" width="40%"></app-skeleton>
      </div>
    </td>
    <td class="px-4 py-4">
      <app-skeleton height="2.5rem"></app-skeleton>
      <div class="mt-2">
        <app-skeleton height="0.6rem" width="60%"></app-skeleton>
      </div>
    </td>
    <td class="px-4 py-4">
      <app-skeleton height="0.85rem" width="50%"></app-skeleton>
    </td>
    <td class="px-4 py-4 text-right">
      <div class="flex justify-end">
        <app-skeleton height="2rem" width="5rem"></app-skeleton>
      </div>
    </td>
  </tr>
</ng-template>

<ng-template #emptyState>
  <div class="flex flex-col items-center justify-center gap-2 py-6 text-sm">
    <svg
      class="h-8 w-8 text-gray-300 dark:text-gray-600"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="1.5"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
      />
    </svg>
    <p class="text-gray-500 dark:text-gray-400">
      @if (searchTerm()) {
        Aucun membre ne correspond à «&nbsp;{{ searchTerm() }}&nbsp;».
      } @else {
        Aucun membre pour cette organisation.
      }
    </p>
  </div>
</ng-template>

<ng-template #paginationFooter>
  <div
    class="flex flex-col gap-3 text-sm text-gray-500 dark:text-gray-400 md:flex-row md:items-center md:justify-between"
  >
    <span>
      Affichage de
      <span class="font-semibold text-gray-900 dark:text-gray-100"
        >{{ paginationInfo().start }}-{{ paginationInfo().end }}</span
      >
      sur
      <span class="font-semibold text-gray-900 dark:text-gray-100"
        >{{ paginationInfo().overall }}</span
      >
      membres
    </span>
    <div class="inline-flex items-center gap-2 text-xs">
      <span class="rounded-full bg-gray-100 px-2 py-1 dark:bg-gray-800">
        {{ filteredMembers().length }} affiché{{ filteredMembers().length > 1 ? 's' : '' }}
      </span>
      <span>
        Recherche :
        @if (searchTerm()) {
          «&nbsp;{{ searchTerm() }}&nbsp;»
        } @else {
          aucune
        }
      </span>
    </div>
  </div>
</ng-template>
